================================================================================
                  MULTI-TAB + PIPELINE SYSTEM MAP (RED PROTOTYPE)
================================================================================

                        HUMAN â†’ BROWSER â†’ AGENT â†’ CLOUD â†’ DB

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                               DOCTOR                                 â”‚
    â”‚   ğŸ¤ Speaks into mic                                                 â”‚
    â”‚   ğŸ‘ï¸ Views multiple EHR tabs (same or different patients)           â”‚
    â”‚   ğŸ–±ï¸ Clicks overlay buttons (Record / Map / Fill)                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ WebRTC mic capture + clicks
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         CHROME EXTENSION                             â”‚
    â”‚  Path: apps/overlay/                                                â”‚
    â”‚                                                                     â”‚
    â”‚  content.js  (per EHR tab)                                          â”‚
    â”‚    â€¢ Injected into each EHR tab                                     â”‚
    â”‚    â€¢ Opens WS to backend (/ws)                                      â”‚
    â”‚    â€¢ Sends "hello" {tabId,url,title,patientHint}                    â”‚
    â”‚    â€¢ Relays audio + DOM maps + commands                             â”‚
    â”‚                                                                     â”‚
    â”‚  overlay.js (Shadow DOM UI)                                         â”‚
    â”‚    â€¢ Ferrari tabs: Summary | SOAP | Transcript | Tasks | Patient | Debug
    â”‚    â€¢ Recorder pill states: idle | connecting | recording | error   â”‚
    â”‚    â€¢ Renders feeds Aâ€“E in real time                                â”‚
    â”‚    â€¢ Smart Fill executor writes into the underlying EHR DOM         â”‚
    â”‚                                                                     â”‚
    â”‚  service worker                                                     â”‚
    â”‚    â€¢ Background messaging + reconnect policies                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ WS + PCM (16k mono)                                 
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             CNS AGENT                                â”‚
    â”‚  Path: apps/cns-agent/                                              â”‚
    â”‚                                                                     â”‚
    â”‚  server.ts                                                          â”‚
    â”‚    â€¢ Express + WebSocket /ws                                        â”‚
    â”‚    â€¢ Registers tabs + doctor sessions                               â”‚
    â”‚    â€¢ Routes audio buffers to Deepgram                               â”‚
    â”‚    â€¢ Broadcasts feeds Aâ€“E                                           â”‚
    â”‚                                                                     â”‚
    â”‚  broker (WS registry)                                               â”‚
    â”‚    â€¢ clients[tabId]: {ws,url,title,patientHint,isActive}            â”‚
    â”‚    â€¢ activeTabId = tab bound by bind_audio                          â”‚
    â”‚    â€¢ Fan-out rules (see FEED ROUTING below)                         â”‚
    â”‚                                                                     â”‚
    â”‚  deepgram consumer                                                  â”‚
    â”‚    â€¢ Streams PCM to Deepgram nova-2 (diarization)                   â”‚
    â”‚    â€¢ Emits partial/final transcripts with speaker labels            â”‚
    â”‚                                                                     â”‚
    â”‚  chunk assembler                                                    â”‚
    â”‚    â€¢ Groups words by speaker                                        â”‚
    â”‚    â€¢ Flushes ~30s windows or on speaker change                      â”‚
    â”‚                                                                     â”‚
    â”‚  supabase client (online/offline)                                   â”‚
    â”‚    â€¢ Writes public.transcripts2 rows                                â”‚
    â”‚    â€¢ transcript_chunk JSONB[] accumulation                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Deepgram WS                                        
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                              DEEPGRAM                                â”‚
    â”‚  â€¢ Receives PCM                                                     â”‚
    â”‚  â€¢ Returns diarized transcripts (speaker, start/end, is_final)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ SQL via Supabase JS                                 
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                               SUPABASE                               â”‚
    â”‚  Table: public.transcripts2                                          â”‚
    â”‚    id (bigint PK)                                                    â”‚
    â”‚    user_id (uuid) â€“ doctor                                           â”‚
    â”‚    patient_code (text) â€“ ephemeral                                   â”‚
    â”‚    patient_uuid (uuid|null) â€“ true identity later                    â”‚
    â”‚    transcript_chunk (jsonb[]) â€“ diarized chunks                      â”‚
    â”‚    transcript (text) â€“ flattened                                     â”‚
    â”‚    ai_summary / ai_short_summary (jsonb) â€“ future                    â”‚
    â”‚    created_at / completed_at                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
                       MULTI-TAB EHR SAFETY (BROWSER SIDE)
================================================================================

    Each EHR tab runs content.js and announces itself:

        { type: "hello", tabId, url, title, patientHint {name?, mrn?} }

    Active audio binding:
      â€¢ overlay on Tab N â†’ ws.send({type:"bind_audio", tabId})
      â€¢ backend sets activeTabId = tabId; all transcript events tagged with tabId
      â€¢ overlay ignores transcript events where event.tabId !== thisTabId

    Patient safety:
      â€¢ If DOM hints differ between tabs (Patient A vs Patient B), backend should
        start a new transcripts2 row or warn before reusing the same session.
      â€¢ Multiple tabs for SAME patient allowed; only one tab carries the audio.

================================================================================
                        FEED ROUTING (BACKEND â†’ OVERLAY)
================================================================================

    Feed A: Transcripts + recorder state
      - record_started / record_stopped
      - transcript {tabId,text,isFinal,speaker,chunk}
      Broadcast: all tabs for that doctor (tabs ignore if tabId mismatch)

    Feed B: Commands / fill plans
      - map_result, fill_plan, undo_result
      Broadcast: origin tab only

    Feed C: Emergency / compliance
      - emergency {phrase, level}
      Broadcast: all tabs

    Feed D: Autopilot readiness
      - autopilot_status {ready, coverage%, surfaces}
      Broadcast: all tabs

    Feed E: Summaries
      - summary_ready {ai_summary, short}
      Broadcast: all tabs

================================================================================
                           RECORDING LIFECYCLE (HAPPY PATH)
================================================================================

    1) Overlay (active tab): click Record
       â†’ send {type:"bind_audio", tabId}
       â†’ send {type:"control", action:"start_record"}

    2) Backend
       â†’ create transcripts2 row (patient_code, user_id)
       â†’ start Deepgram session
       â†’ notify feed A: record_started

    3) Streaming loop
       â†’ PCM from content.js â†’ Deepgram â†’ transcript JSON
       â†’ chunk assembler emits ~30s blocks with speaker labels
       â†’ feed A broadcast (tagged with tabId)
       â†’ save transcript_chunk to transcripts2

    4) Stop
       â†’ overlay sends {type:"control", action:"stop_record"}
       â†’ backend flushes assembler, updates completed_at
       â†’ feed A: record_stopped

    5) Post-processing (future)
       â†’ Summaries (feed E), structured SOAP, compliance flags
       â†’ Smart Fill plans (feed B) for DOM injection

================================================================================
                          DOM MAP + SMART FILL (MVP LOOP)
================================================================================

    Map Page (manual trigger):
      overlay â†’ content.js:
        {type:"command", action:"map_page"}
      content.js scans DOM â†’ fields[], patientHint
      â†’ sends to backend (persist optional) + echoes to overlay (Patient tab)

    Smart Fill:
      overlay requests fill_plan (backend) using transcript + fields
      backend returns steps[] (selector, value, mode)
      overlay executes via content.js into active tab DOM
      undo sends revert steps if supported

================================================================================
                               PORT & ENV (CURRENT)
================================================================================

    Agent:    PORT=3001 (see .env, adjust if running at 8787 per legacy docs)
    Supabase: SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY
    Deepgram: DEEPGRAM_API_KEY

================================================================================
                                WHAT EXISTS TODAY
================================================================================

    Backend: Express + WS scaffold, Deepgram/Supabase wiring partial.
    Overlay: Red prototype; connects to WS; UI/feeds/mapping largely stubbed.
    Docs: ASSISTMD_TRUTH_PACKAGE.md, SYSTEM_MAP/*, diagrams, troubleshooting.

================================================================================
                                NEAR-TERM TARGETS
================================================================================

    â€¢ Finish Ferrari overlay tabs + recorder pill UX
    â€¢ Wire real-time transcript rendering with speaker labels (Feed A)
    â€¢ Implement multi-tab safety (hello + bind_audio enforcement)
    â€¢ Persist transcript_chunk to transcripts2 end-to-end
    â€¢ Deliver Map â†’ Fill â†’ Undo MVP loop
    â€¢ Add summary feed (E) once transcript pipeline is solid

================================================================================
