================================================================================
                     GHOST-NEXT FULL STACK SYSTEM MAP
================================================================================

                            COMPLETE DATA FLOW
================================================================================

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                           BROWSER LAYER                                  │
    │  ┌─────────────────────────────────────────────────────────────────────┐│
    │  │                    Chrome Extension (MV3)                           ││
    │  │                                                                     ││
    │  │   ┌───────────────┐     ┌───────────────┐     ┌────────────────┐  ││
    │  │   │  content.ts   │────▶│  overlay.ts   │     │ background.ts  │  ││
    │  │   │  (injector)   │     │  (Ferrari UI) │     │ (svc worker)   │  ││
    │  │   └───────────────┘     └───────┬───────┘     └────────┬───────┘  ││
    │  │                                 │                       │          ││
    │  │   ┌───────────────┐     ┌───────┴───────┐              │          ││
    │  │   │ domMapper.ts  │◀────│   bridge.ts   │◀─────────────┘          ││
    │  │   │ (field scan)  │     │  (messaging)  │                         ││
    │  │   └───────────────┘     └───────┬───────┘                         ││
    │  │                                 │                                  ││
    │  │   ┌───────────────┐             │                                  ││
    │  │   │audio-capture  │─────────────┤                                  ││
    │  │   │   (PCM)       │             │                                  ││
    │  │   └───────────────┘             │                                  ││
    │  │                                 │                                  ││
    │  └─────────────────────────────────┼──────────────────────────────────┘│
    │                                    │                                   │
    └────────────────────────────────────┼───────────────────────────────────┘
                                         │
                    WebSocket (/ws)      │       Binary Audio
                    JSON Messages        │       PCM 16kHz
                                         │
    ┌────────────────────────────────────┼───────────────────────────────────┐
    │                                    │                                   │
    │                           BACKEND LAYER                                │
    │  ┌─────────────────────────────────┼──────────────────────────────────┐│
    │  │                    Agent Server (Express)                          ││
    │  │                                 │                                  ││
    │  │   ┌───────────────┐     ┌───────┴───────┐     ┌────────────────┐  ││
    │  │   │  server.ts    │────▶│   ws/broker   │────▶│ routes/*.ts    │  ││
    │  │   │  (main)       │     │  (dispatch)   │     │ (REST API)     │  ││
    │  │   └───────────────┘     └───────┬───────┘     └────────────────┘  ││
    │  │                                 │                                  ││
    │  │                         ┌───────┴───────┐                         ││
    │  │                         │    audio/     │                         ││
    │  │                         │deepgram.ts    │                         ││
    │  │                         │ (consumer)    │                         ││
    │  │                         └───────┬───────┘                         ││
    │  │                                 │                                  ││
    │  │   ┌───────────────┐             │                                  ││
    │  │   │lib/supabase.ts│◀────────────┘                                  ││
    │  │   │  (queries)    │                                               ││
    │  │   └───────┬───────┘                                               ││
    │  │           │                                                        ││
    │  └───────────┼────────────────────────────────────────────────────────┘│
    │              │                                                         │
    └──────────────┼─────────────────────────────────────────────────────────┘
                   │
                   │ HTTPS API
                   │
    ┌──────────────┼─────────────────────────────────────────────────────────┐
    │              │                                                         │
    │              │               EXTERNAL SERVICES                         │
    │              │                                                         │
    │   ┌──────────┴──────────┐                    ┌─────────────────────┐  │
    │   │                     │                    │                     │  │
    │   │      SUPABASE       │                    │      DEEPGRAM       │  │
    │   │                     │                    │                     │  │
    │   │  ┌───────────────┐  │                    │  ┌───────────────┐  │  │
    │   │  │ transcripts2  │  │                    │  │   nova-2      │  │  │
    │   │  │    table      │  │    WebSocket ◀────────│   model       │  │  │
    │   │  └───────────────┘  │    Streaming       │  │               │  │  │
    │   │                     │                    │  │  diarization  │  │  │
    │   │  ┌───────────────┐  │                    │  │  punctuation  │  │  │
    │   │  │transcript_    │  │                    │  │  smart_format │  │  │
    │   │  │  chunks       │  │                    │  └───────────────┘  │  │
    │   │  └───────────────┘  │                    │                     │  │
    │   │                     │                    │                     │  │
    │   └─────────────────────┘                    └─────────────────────┘  │
    │                                                                        │
    └────────────────────────────────────────────────────────────────────────┘


================================================================================
                            MESSAGE FLOW SEQUENCE
================================================================================

    User            Overlay          Agent           Deepgram        Supabase
      │               │                │                │               │
      │ click Record  │                │                │               │
      │──────────────▶│                │                │               │
      │               │ session:start  │                │               │
      │               │───────────────▶│                │               │
      │               │                │ createRun()    │               │
      │               │                │───────────────────────────────▶│
      │               │                │◀──────────────────────uuid─────│
      │               │                │ connect()      │               │
      │               │                │───────────────▶│               │
      │               │                │◀──connected────│               │
      │               │◀─session:ready─│                │               │
      │               │                │                │               │
      │   speak       │                │                │               │
      │ ═════════════▶│                │                │               │
      │               │ audio chunks   │                │               │
      │               │═══════════════▶│═══════════════▶│               │
      │               │                │◀══transcript═══│               │
      │               │◀─transcript────│                │               │
      │               │                │ saveChunk()    │               │
      │               │                │───────────────────────────────▶│
      │   see text    │                │                │               │
      │◀──────────────│                │                │               │
      │               │                │                │               │
      │ click Stop    │                │                │               │
      │──────────────▶│                │                │               │
      │               │ session:stop   │                │               │
      │               │───────────────▶│ finish()       │               │
      │               │                │───────────────▶│               │
      │               │                │◀──final────────│               │
      │               │◀─transcript────│ updateStatus() │               │
      │               │                │───────────────────────────────▶│
      │               │◀─session:ended─│                │               │
      │               │                │                │               │


================================================================================
                              PORT ASSIGNMENTS
================================================================================

    Service                 Port        Protocol
    ─────────────────────────────────────────────
    Agent Server            3001        HTTP/WS
    Chrome Extension        N/A         Extension API
    Supabase                443         HTTPS
    Deepgram                443         WSS


================================================================================
                            ENVIRONMENT VARIABLES
================================================================================

    Backend (agent/.env)
    ────────────────────
    PORT=3001
    DEEPGRAM_API_KEY=<key>
    SUPABASE_URL=<url>
    SUPABASE_SERVICE_ROLE_KEY=<key>
    NODE_ENV=development

    Extension (chrome.storage)
    ──────────────────────────
    agentUrl=ws://localhost:3001/ws
    providerId=<provider_id>


================================================================================
                              FILE STRUCTURE
================================================================================

    ghost/
    ├── backend/
    │   ├── src/
    │   │   ├── server.ts           # Express + WS server
    │   │   ├── audio/
    │   │   │   └── consumers/
    │   │   │       └── deepgram.ts # Deepgram streaming
    │   │   ├── lib/
    │   │   │   └── supabase.ts     # DB client + queries
    │   │   └── routes/
    │   │       ├── transcripts.ts  # /transcripts endpoints
    │   │       └── patient.ts      # /patient endpoints
    │   ├── package.json
    │   └── tsconfig.json
    │
    ├── extension/
    │   ├── src/
    │   │   ├── content.ts          # Content script
    │   │   ├── overlay.ts          # Ferrari UI
    │   │   ├── background.ts       # Service worker
    │   │   ├── bridge.ts           # Messaging
    │   │   ├── audio-capture.ts    # PCM recorder
    │   │   ├── domMapper.ts        # Field detection
    │   │   └── ui/                 # Components
    │   ├── manifest.json
    │   ├── build.mjs
    │   └── package.json
    │
    ├── supabase/
    │   ├── transcripts2-schema.sql
    │   ├── transcript-chunks.sql
    │   └── rls-policies.sql
    │
    ├── docs/
    │   ├── SPEC/
    │   ├── SYSTEM_MAP/
    │   ├── ANTIGRAVITY/
    │   └── TROUBLESHOOT/
    │
    └── scripts/
        ├── start-mcp.sh
        └── build-extension.mjs
